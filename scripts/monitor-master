import json
from chaosindy.probes.validator_info import get_validator_info, get_chaos_temp_dir
from os.path import expanduser
from os import getenv

# TODO: use argparse to get user input
genesis_file = getenv("CHAOS_GENESIS_FILE") or '/home/ubuntu/chaosindy/pool_transactions_genesis'

# Generate a temp dir containing JSON for each validator node
get_validator_info(genesis_file)
temp_dir = get_chaos_temp_dir()

aliases = []
with open(expanduser(genesis_file), 'r') as genesisfile:
    for line in genesisfile:
        aliases.append(json.loads(line)['txn']['data']['data']['alias'])

# Extract Catchup_status for the domain ledger for each validator_node
print("Node\tMaster")
print("")
for node in sorted(aliases):
    filename = "{}/{}-validator-info".format(temp_dir, node)
    try:
        with open(filename, 'r') as f:
            validator_info = json.load(f)
        print("{}\t{}".format( node,
            validator_info['data']['Node_info']['Replicas_status']['{}:0'.format(node)]['Primary'] ))
    except:
        print("{}\t{}".format( node, 'Unknown' ))
